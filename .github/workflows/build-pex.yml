---
name: Build PEX

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pex
        run: pip install pex

      - name: Build PEX
        run: |
          echo "requests>=2.31.0" > /tmp/pex-requirements.txt
          echo "keyring>=24.0.0" >> /tmp/pex-requirements.txt
          echo "PyYAML>=6.0" >> /tmp/pex-requirements.txt
          pex . \
            -r /tmp/pex-requirements.txt \
            -c pia-nm \
            -o pia-nm.pex \
            --python-shebang "/usr/bin/env python3"
          chmod +x pia-nm.pex

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pia-nm-pex
          path: pia-nm.pex

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: pia-nm.pex
          token: ${{ secrets.RELEASE_TOKEN }}
          body: |
            ## Installation

            ```bash
            # Download the PEX file
            curl -L -o pia-nm https://github.com/abirkel/pia-nm/releases/download/${{ github.ref_name }}/pia-nm.pex
            
            # Make it executable
            chmod +x pia-nm
            
            # Move to your PATH
            mkdir -p ~/.local/bin
            mv pia-nm ~/.local/bin/
            
            # Verify installation
            pia-nm --help
            ```

            See [INSTALL.md](INSTALL.md) for detailed instructions.
